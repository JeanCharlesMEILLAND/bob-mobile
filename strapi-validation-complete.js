// strapi-validation-complete.js - Test complet de l'architecture Strapi configur√©e
const https = require('https');
const http = require('http');

const API_BASE_URL = 'http://46.202.153.43:1337';

function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const urlObj = new URL(url);
    const lib = urlObj.protocol === 'https:' ? https : http;
    
    const reqOptions = {
      hostname: urlObj.hostname,
      port: urlObj.port,
      path: urlObj.pathname + urlObj.search,
      method: options.method || 'GET',
      headers: options.headers || {}
    };
    
    const req = lib.request(reqOptions, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => resolve({
        status: res.statusCode,
        headers: res.headers,
        body: data
      }));
    });
    
    req.on('error', reject);
    
    if (options.body) {
      req.write(options.body);
    }
    req.end();
  });
}

// Donn√©es de test compl√®tes pour valider l'architecture
const testData = {
  
  // 1. Cat√©gorie
  categories: {
    data: {
      nom: "Bricolage",
      description: "Outils et mat√©riel de bricolage",
      icone: "üî®",
      couleur: "#3B82F6",
      active: true,
      populaire: true,
      nombreBobs: 0,
      ordre: 1,
      niveau: 0,
      mots_cles: "outils, bricolage, r√©paration, construction",
      metadata: {
        keywords: ["bricolage", "outils"],
        created_by: "system"
      }
    }
  },
  
  // 2. Tag
  tags: {
    data: {
      nom: "urgent",
      description: "√âl√©ment n√©cessaire rapidement",
      couleur: "#EF4444",
      nombreUtilisations: 0,
      populaire: false,
      metadata: {
        usage_context: "time_sensitive"
      }
    }
  },
  
  // 3. Bob complet avec tous les nouveaux champs
  echanges: {
    data: {
      titre: "Perceuse Bosch Pro 18V",
      description: "Perceuse sans fil professionnelle en excellent √©tat. Batterie neuve, mallette compl√®te avec forets.",
      type: "pret",
      statut: "actif",
      dureeJours: 7,
      conditions: "Utilisation soigneuse demand√©e. Retour propre avec tous les accessoires.",
      bobizGagnes: 25,
      
      // Nouveaux champs de cat√©gorisation
      urgence: "normale",
      mots_cles: "perceuse, bricolage, pro, 18V",
      
      // G√©olocalisation avanc√©e
      ville: "Paris",
      rayonAcceptable: 15,
      livraisonPossible: true,
      
      // √âconomie avanc√©e
      bobizProposed: 25,
      negociable: true,
      
      // Dates d√©taill√©es
      dateRenduPrevu: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
      
      // Interaction sociale
      vues: 0,
      interessesCount: 0,
      partages: 0,
      signalements: 0,
      
      // Chat
      chatActif: true,
      messagesCount: 0,
      
      // M√©tadonn√©es
      flexibiliteHoraire: true,
      sourceCreation: "app",
      versionApp: "1.0.0",
      metadata: {
        brand: "Bosch",
        model: "GSR 18V-28",
        year: "2023",
        accessories: ["charger", "battery", "drill_bits", "case"],
        condition: "excellent",
        estimated_value: 200
      }
    }
  },
  
  // 4. Contact complet
  contacts: {
    data: {
      nom: "Martin",
      prenom: "Pierre",
      telephone: "+33612345679",
      email: "pierre.martin@example.com",
      surnom: "Pierre le Bricoleur",
      
      // Relation sociale
      statut: "ami",
      relation: "Voisin du dessus, bricoleur exp√©riment√©",
      confiance: "forte",
      
      // √âtat Bob
      aBob: true,
      invitationAcceptee: true,
      nombreInvitationsEnvoyees: 1,
      
      // Interaction
      nombreBobsEnsemble: 5,
      dernierBobEnsemble: new Date().toISOString(),
      noteRelation: 4.8,
      favoris: true,
      
      // Historique
      dateAjout: new Date().toISOString(),
      dernierContact: new Date().toISOString(),
      sourceAjout: "telephone",
      
      // Notes
      notes: "Tr√®s fiable, excellent bricoleur. Toujours pr√™t √† aider.",
      metadata: {
        specialites: ["plomberie", "√©lectricit√©", "menuiserie"],
        disponibilite: "weekend_soir",
        tools_owned: ["perceuse", "scie", "niveau"]
      }
    }
  },
  
  // 5. Message complet
  messages: {
    data: {
      contenu: "Salut Pierre ! Ta perceuse est-elle toujours disponible pour ce weekend ?",
      type: "texte",
      
      // √âtat message
      lu: false,
      supprime: false,
      edite: false,
      
      // M√©tadonn√©es
      metadataMessage: {
        platform: "mobile",
        app_version: "1.0.0",
        message_id: "msg_" + Date.now()
      },
      version: "1.0"
    }
  },
  
  // 6. Transaction compl√®te
  transactions: {
    data: {
      montant: 25,
      type: "gain",
      statut: "validee",
      source: "bob_termine",
      description: "Bobiz gagn√©s pour pr√™t de perceuse √† Pierre",
      automatique: true,
      dateValidation: new Date().toISOString(),
      referenceExterne: "bob_" + Date.now(),
      metadata: {
        bob_id: null, // Sera li√© apr√®s cr√©ation du Bob
        transaction_type: "peer_to_peer",
        fees: 0
      }
    }
  },
  
  // 7. √âvaluation compl√®te
  evaluations: {
    data: {
      note: 5,
      commentaire: "Excellent √©change ! Perceuse en parfait √©tat, Pierre tr√®s sympa et ponctuel. Je recommande √† 100% !",
      type: "bob",
      
      // Crit√®res d√©taill√©s
      ponctualite: 5,
      communication: 5,
      qualiteService: 5,
      confiance: 5,
      recommande: true,
      
      // Visibilit√©
      publique: true,
      signale: false,
      utile: 0,
      
      metadata: {
        review_id: "review_" + Date.now(),
        helpful_votes: 0,
        review_length: "detailed"
      }
    }
  },
  
  // 8. Notification compl√®te
  notifications: {
    data: {
      titre: "Bob accept√© !",
      message: "Pierre a accept√© votre demande de pr√™t pour la perceuse Bosch. Vous pouvez maintenant organiser la remise.",
      type: "bob",
      
      // √âtat
      lue: false,
      archivee: false,
      
      // Action
      actionRequise: true,
      actionType: "organize_handover",
      actionData: {
        bob_id: null, // Sera li√© apr√®s cr√©ation
        next_step: "contact_lender",
        deadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
      },
      actionUrl: "/bobs/organize-handover",
      
      // Delivery
      canalEnvoi: "app",
      dateEnvoi: new Date().toISOString(),
      tentativesEnvoi: 1,
      
      // Priorit√©
      priorite: "haute",
      
      metadata: {
        notification_id: "notif_" + Date.now(),
        auto_generated: true,
        category: "bob_interaction"
      }
    }
  },
  
  // 9. Groupe de contacts
  'groupes-contacts': {
    data: {
      nom: "Bricoleurs du quartier",
      description: "Mes amis bricoleurs et voisins serviables",
      icone: "üî®",
      couleur: "#3B82F6",
      type: "bricoleurs",
      prive: true,
      nombreMembres: 0,
      nombreBobsGroupe: 0,
      metadata: {
        created_date: new Date().toISOString(),
        group_type: "hobby_based",
        activity_level: "high"
      }
    }
  }
};

async function validateCompleteArchitecture() {
  console.log('üèóÔ∏è Validation compl√®te de l\'architecture Strapi Bob...\n');
  
  try {
    // 1. Se connecter
    const loginResponse = await makeRequest(`${API_BASE_URL}/api/auth/local`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        identifier: 'debug-user',
        password: 'DebugTest123!'
      })
    });
    
    if (loginResponse.status !== 200) {
      throw new Error(`Erreur login: ${loginResponse.status}`);
    }
    
    const token = JSON.parse(loginResponse.body).jwt;
    console.log('‚úÖ Connexion r√©ussie\n');
    
    // 2. Tester chaque collection avec donn√©es compl√®tes
    console.log('üß™ === TEST COMPLET DES COLLECTIONS ===\n');
    
    const results = {};
    
    for (const [collectionName, data] of Object.entries(testData)) {
      try {
        console.log(`üîÑ Test complet /${collectionName}...`);
        
        const response = await makeRequest(`${API_BASE_URL}/api/${collectionName}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        
        console.log(`   Status: ${response.status}`);
        
        if (response.status === 201) {
          const result = JSON.parse(response.body);
          results[collectionName] = result.data;
          
          console.log(`   ‚úÖ ${collectionName} - Cr√©ation r√©ussie avec ID: ${result.data.id}`);
          
          // Compter les champs sauvegard√©s
          const fieldsCount = Object.keys(result.data).length - 5; // Exclure les champs Strapi auto
          console.log(`   üìä ${fieldsCount} champs personnalis√©s sauvegard√©s`);
          
          // V√©rifier les champs metadata
          if (result.data.metadata) {
            console.log(`   üîó M√©tadonn√©es JSON: ${Object.keys(result.data.metadata).length} propri√©t√©s`);
          }
          
        } else if (response.status === 404) {
          console.log(`   ‚ùå Collection /${collectionName} n'existe pas - √Ä cr√©er dans Strapi admin`);
          results[collectionName] = { error: 'Collection manquante' };
          
        } else if (response.status === 400) {
          const errorBody = JSON.parse(response.body);
          console.log(`   ‚ö†Ô∏è Champs manquants - ${errorBody.error?.message}`);
          console.log(`   üí° Champ invalide: ${errorBody.error?.details?.key}`);
          results[collectionName] = { error: 'Champs manquants', details: errorBody.error?.details };
          
        } else {
          console.log(`   ‚ùå Erreur ${response.status}: ${response.body.substring(0, 100)}`);
          results[collectionName] = { error: `Status ${response.status}` };
        }
        
      } catch (error) {
        console.log(`   ‚ùå Erreur r√©seau: ${error.message}`);
        results[collectionName] = { error: error.message };
      }
      console.log('');
    }
    
    // 3. R√©sum√© des r√©sultats
    console.log('üìä === R√âSUM√â DE LA VALIDATION ===\n');
    
    const successful = Object.entries(results).filter(([_, result]) => result.id).length;
    const missing = Object.entries(results).filter(([_, result]) => result.error === 'Collection manquante').length;
    const incomplete = Object.entries(results).filter(([_, result]) => result.error === 'Champs manquants').length;
    const errors = Object.entries(results).filter(([_, result]) => result.error && !['Collection manquante', 'Champs manquants'].includes(result.error)).length;
    
    console.log(`‚úÖ Collections fonctionnelles: ${successful}/9`);
    console.log(`‚ùå Collections manquantes: ${missing}/9`);
    console.log(`‚ö†Ô∏è Collections incompl√®tes: ${incomplete}/9`);
    console.log(`üî• Erreurs techniques: ${errors}/9`);
    console.log('');
    
    // 4. Plan d'action
    console.log('üìã === PLAN D\'ACTION ===\n');
    
    if (missing > 0) {
      console.log('üèóÔ∏è Collections √† cr√©er dans Strapi admin:');
      Object.entries(results).forEach(([name, result]) => {
        if (result.error === 'Collection manquante') {
          console.log(`   - ${name}`);
        }
      });
      console.log('');
    }
    
    if (incomplete > 0) {
      console.log('üîß Collections √† compl√©ter (champs manquants):');
      Object.entries(results).forEach(([name, result]) => {
        if (result.error === 'Champs manquants') {
          console.log(`   - ${name}: ${result.details?.key || 'Voir d√©tails'}`);
        }
      });
      console.log('');
    }
    
    if (successful === 9) {
      console.log('üéâ SUCC√àS COMPLET ! Architecture Strapi parfaitement configur√©e !');
      console.log('üöÄ Vous pouvez maintenant sauvegarder TOUT l\'√©cosyst√®me Bob !');
    } else {
      console.log(`üìà Progression: ${Math.round(successful/9*100)}% de l'architecture configur√©e`);
      console.log('üìñ Consultez STRAPI-CONFIGURATION-GUIDE.md pour compl√©ter');
    }
    
    // 5. Test des relations (si collections cr√©√©es)
    if (successful >= 3) {
      console.log('\nüîó === TEST DES RELATIONS ===\n');
      console.log('üí° Une fois toutes les collections cr√©√©es, tester les relations:');
      console.log('   - User ‚Üí Echanges (cr√©ateur)');
      console.log('   - Echanges ‚Üí Categories'); 
      console.log('   - Echanges ‚Üí Tags');
      console.log('   - User ‚Üí Contacts');
      console.log('   - Echanges ‚Üí Messages');
    }
    
  } catch (error) {
    console.error('‚ùå Erreur g√©n√©rale:', error.message);
  }
}

validateCompleteArchitecture();